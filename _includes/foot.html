<script>
  "use strict";

  /** Load maps into containers which specify a GPX source.
   *
   * If a div has the `route-map` class and specifies a URL to a GPX file in
   * its `data-route` attribute, this method will instantiate a Leaflet map
   * widget inside that div using the data from the GPX file.
   */
  let loadMaps = () => {
    const containers = document.getElementsByClassName("route-map");
    Array.prototype.forEach.call(containers, (el) => {
      // Check that the element defines the required data
      const route_url = el.dataset["route"];
      if (route_url === undefined) {
        console.error("Route map element does not define data-route property", el);
      }

      // Set up the map
      const map = L.map(el);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>',
      }).addTo(map);
      L.control.scale().addTo(map);

      // Fetch the GPX file and add it to the map
      omnivore
        .gpx(route_url)
        .on("ready", (event) => map.fitBounds(event.target.getBounds()))
        .addTo(map);
    });
  }

  window.addEventListener("DOMContentLoaded", (_event) => {
    loadMaps();
  });
</script>
